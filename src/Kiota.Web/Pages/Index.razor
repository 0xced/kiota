@page "/"
@using Kiota.Builder
@using Kiota.Builder.SearchProviders
@using Kiota.Builder.Configuration
@using System.Linq
@inject ILoggerFactory LoggerFactory
@using System.Globalization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<Index> Loc

<PageTitle>@Loc["PageTitle"]</PageTitle>

<h1>@Loc["Search"]</h1>

<div>
    <div class="form-group">
        <div class="form-row">
            <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-6">
                <label for="term">@Loc["SearchTermOrKey"]</label>
                <input id="term" type="text" @bind="SearchTerm" class="form-control" required="true" />
            </div>
        </div>
    </div>
    <button @onclick="SearchDocuments" class="btn btn-primary">@Loc["SearchAction"]</button>
</div>

@if (SearchResults.Any() && (SearchTerm?.Contains("::") ?? false) && SearchResults.ContainsKey(SearchTerm)) {
    var singleResult = SearchResults[SearchTerm];
    <div id="single-result">
        <h2>@Loc["SingleResult"]</h2>
        <p>
            <span>@Loc["SR_Key"]</span><a href="@singleResult.DescriptionUrl" target="_blank">@SearchTerm</a><br />
            <span>@Loc["SR_Description"]</span>@singleResult.Description<br />
            <span>@Loc["SR_ServiceRoot"]</span>@singleResult.ServiceUrl<br />
            <span>@Loc["SR_Versions"]</span>@(string.Join(", ", singleResult.VersionLabels))<br />
        </p>
    </div>
} else if (SearchResults.Any()) {
    <div id="results">
        <h2>@Loc["MultipleResults"]</h2>
        <table>
            <thead>
                <tr>
                    <th>@Loc["MR_Key"]</th>
                    <th>@Loc["MR_Description"]</th>
                    <th>@Loc["MR_Versions"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var result in SearchResults)
                {
                    <tr>
                        <td><a href="@result.Value.DescriptionUrl" target="_blank">@result.Key</a></td>
                        <td><p>@result.Value.Description</p></td>
                        <td><p>
                            @foreach (var versionLabel in result.Value.VersionLabels)
                            {
                                var target = $"/show?k={result.Key}&v={versionLabel}";
                                <NavLink class="nav-link" href="@target">
                                    @versionLabel
                                </NavLink>
                            }
                        </p></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private string? SearchTerm { get; set; }
    private IDictionary<string, SearchResult> SearchResults = new Dictionary<string, SearchResult>();
    private async Task SearchDocuments() {
        var searchConfig = new SearchConfiguration() {
            SearchTerm = SearchTerm,
        };
        var logger = LoggerFactory.CreateLogger<KiotaSearcher>();
        SearchResults = await new KiotaSearcher(logger, searchConfig).SearchAsync(new CancellationToken());
    }
}
